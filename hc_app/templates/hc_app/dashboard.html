{% extends 'hc_app/base.html' %}
{% load static %}
{% block title %}Vendor Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'hc_app/dashboard.css' %}">
{% endblock %}

{% block content %}
<h1>Vendor Dashboard -- Shipping & Order Fulfillment</h1>

<div class="container">
    <div class="div1">
        <h2>Customers</h2>
        <div class="stat-value">{{ total_customers }}</div>   <!-- edit22 - edit <div class="stat-value">0</div>-->
    </div>

    <div class="div2">
        <h2>Orders</h2>
        <div class="stat-value">{{ total_orders }}</div>   <!-- edit22 - edit <div class="stat-value">0</div>-->
    </div>

    <div class="div3">
        <h2>Monthly Sales</h2>
        <div class="mb-2 d-flex gap-2 align-items-center">
            <label for="dashboard-category" class="small mb-0">Filter by category:</label>
            <select id="dashboard-category" class="form-select form-select-sm w-auto">
                <option value="">All categories</option>
                {% for c in categories %}
                    <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
            </select>
        </div>
    <canvas id="monthly-sales-canvas" class="chart-placeholder" aria-label="Monthly sales chart" role="img"></canvas>
    </div>

    <div class="div4">
        <h2>Monthly Target + Order Cap</h2>
    <canvas id="target-vs-actual-canvas" class="chart-placeholder" aria-label="Target vs actual chart" role="img"></canvas>
    </div>

    <div class="div5">
        <h2>Customer Demographics</h2>
        <div id="ph-map"></div>
        <div id="ph-legend" class="map-legend" aria-hidden="false"></div>
    </div>

    <div class="div6">
        <h2>Recent Orders</h2>   <!-- edit22 - edited -->
        <ul>
            {% for order in recent_orders %}
                <li>
                    Order #{{ order.id }} â€” {{ order.status }}

                    <form method="post" action="{% url 'hc_app:update_order_status' order.id %}" class="d-inline">
                        {% csrf_token %}
                        <select name="status" class="form-select form-select-sm d-inline w-auto">
                            {% for s in statuses %}
                                <option value="{{ s }}" {% if order.status == s %}selected{% endif %}>{{ s }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-sm btn-outline-primary">Update</button>
                    </form>
                </li>
            {% empty %}
                <li>No recent orders</li>
            {% endfor %}
        </ul>
    </div>

    <div class="div8">
        <h2>My Listings</h2>   <!-- edit22 - added -->
        <ul>
            {% for product in user_products %}
                <li>
                    <a href="{% url 'hc_app:product_detail' product.id %}">{{ product.name }}</a>
                </li>
            {% empty %}
                <li>No products listed yet.</li>
            {% endfor %}
        </ul>
    </div>

    <div class="div-cart">
        <h2>Interested (In Cart)</h2>
        <div class="stat-value">{{ in_cart_total|default:0 }}</div>
        <div id="recent-cart-activity" class="mt-2 text-sm">
            <p class="text-muted">No recent cart activity.</p>
        </div>
    </div>

    <div class="div9">
        <h2>Seller Workflow</h2>
        <p>Manage your custom order scheduling and progress here.</p>

        <form method="post" action="{% url 'hc_app:workflow_create' %}" class="mb-3">
            {% csrf_token %}
            <div class="row g-2">
                <div class="col-md-4">
                    <input type="text" name="title" class="form-control" placeholder="Task title (e.g. Finish custom design)" required>
                </div>
                <div class="col-md-3">
                    <select name="product" class="form-select">
                        <option value="">Select product (optional)</option>
                        {% for p in user_products %}
                        <option value="{{ p.id }}">{{ p.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="date" name="due_date" class="form-control">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-sm btn-primary" type="submit">Add task</button>
                </div>
            </div>
        </form>

        <ul class="list-group">
            {% for task in workflow_tasks %}
            <li class="list-group-item d-flex justify-content-between align-items-start">
                <div>
                    <strong>{{ task.title }}</strong>
                    {% if task.product %}<div class="small text-muted">Product: {{ task.product.name }}</div>{% endif %}
                    {% if task.due_date %}<div class="small text-muted">Due: {{ task.due_date }}</div>{% endif %}
                    <div class="small">Status: {{ task.get_status_display }}</div>
                </div>
                <div class="btn-group">
                    <a href="{% url 'hc_app:workflow_update' task.id %}" class="btn btn-sm btn-outline-secondary">Edit</a>
                    <form method="post" action="{% url 'hc_app:workflow_delete' task.id %}" style="display:inline">
                        {% csrf_token %}
                        <button class="btn btn-sm btn-danger" type="submit">Delete</button>
                    </form>
                </div>
            </li>
            {% empty %}
            <li class="list-group-item">No workflow tasks yet.</li>
            {% endfor %}
        </ul>
    </div>


    <div class="div7">
        <h2>Customer Inquiries</h2>
        <div class="chat-container">
            <div class="chat-list">    
                {% for user in users %}  <!-- edit22 - edited <div class="chat-user" data-user="1">Fn. Ln.</div> -->
                    <div class="chat-user" data-user="{{ user.id }}">
                        <span>{{ user.username }}</span>
                        <form method="post" action="{% url 'hc_app:message_user' user.id %}" class="d-flex gap-2 mt-1">
                            {% csrf_token %}
                            <input type="text" name="message" placeholder="Type a message..." class="form-control form-control-sm" required>
                            <button type="submit" class="btn btn-sm btn-primary">Send</button>
                        </form>
                    </div>
                {% endfor %}
            </div>

            <div class="chat-window hidden">
                <div class="chat-header">
                    <span class="chat-username">Select a chat</span>
                </div>

                <div class="messages">
                    {% if db_ok is defined and not db_ok %}
                        <div class="alert alert-warning">Dashboard messages are unavailable because the database is not fully migrated on this environment. Please run migrations.</div>
                    {% endif %}

                    {% for quote in recent_quotes %}
                        <div class="chat-message mb-2">
                            <div class="chat-message-header">
                                <span class="chat-message-date">{{ quote.created_at|date:"F j, Y" }}</span>
                            </div>
                            <div class="chat-message-body">
                                <p><strong>{{ quote.buyer.username }}</strong>: {{ quote.message }}</p>
                                <small class="text-muted">({{ quote.created_at|date:"Y-m-d H:i" }})</small>
                            </div>
                        </div>
                    {% empty %}
                        <p>No quotes yet.</p>
                    {% endfor %}
                </div>

                <div class="chat-input">
                    <input type="text" placeholder="Type a message...">
                    <button>Send</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js (lightweight CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // API endpoints used by the dashboard script
    window.DASHBOARD_ENDPOINTS = {
            stats: '{% url "hc_app:dashboard_stats" %}',
            cart_activity: '{% url "hc_app:dashboard_cart_activity" %}',
            map_points: '{% url "hc_app:dashboard_map_points" %}'
    };
</script>
    <!-- Try to load a vendored Chart.js first (place chart.min.js in static/hc_app/vendor/), fallback to CDN if missing -->
    <script src="{% static 'hc_app/vendor/chart.min.js' %}"></script>
    <script>
        (function(){
            if (typeof Chart === 'undefined') {
                var s = document.createElement('script');
                s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
                s.crossOrigin = 'anonymous';
                document.head.appendChild(s);
            }
        })();
    </script>
    <!-- amCharts 5: load core, map module, Philippines geodata and animated theme -->
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/geodata/philippinesLow.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="{% static 'hc_app/scripts/dashboard.js' %}"></script>
{% endblock %}
