{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}HandacraftPH{% endblock %}</title>
    <meta name="description" content="Discover, buy, and sell handmade crafts from Filipino artisans at HandaCraftPH.">
    <meta name="keywords" content="handicrafts, handmade, Philippines, artisan, crafts, marketplace">

    <meta property="og:title" content="HandaCraftPH â€” Buy and Sell Handmade Crafts">
    <meta property="og:description" content="Support local artisans and explore unique handmade creations at HandaCraftPH.">
    <meta property="og:image" content="{% static 'hc_app/images/logo.png' %}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://handacraftph.onrender.com/">

    <link rel="preload" href="{% static 'hc_app/images/logo.png' %}" as="image">
    <link rel="stylesheet" href="{% static 'hc_app/main.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    {% block extra_css %}{% endblock %}

</head>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>
<body class="{% block body_class %}{% endblock %}">

    <header>
        <div class="logo">
            <img src="{% static 'hc_app/images/logo.png' %}" alt="HandacraftPH Logo" loading="lazy">
            <h1>HandacraftPH</h1>
            <p>Discover. Customize. Support Local.</p>
        </div>

        <nav>
            <ul>
                <li><a href="{% url 'hc_app:home' %}">Home</a></li>
                <li class="nav-item dropdown">    <!-- edit22 - edited <li><a href="#">Categories</a></li> -->
                    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">Categories</a>
                    <ul class="dropdown-menu">
                        {% for category in categories %}
                            <li>
                                {% if category.slug %}
                                    <a class="dropdown-item" href="{% url 'hc_app:category_products' category.slug %}">{{ category.name }}</a>
                                {% else %}
                                    <a class="dropdown-item" href="{% url 'hc_app:category_products' category.name %}">{{ category.name }}</a>
                                {% endif %}
                            </li>
                        {% endfor %}
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{% url 'hc_app:catalog' %}">View all products</a></li>
                    </ul>
                    </li>
                <li><a href="{% url 'hc_app:customize' %}">Customize</a></li>
                <li><a href="{% url 'hc_app:sell' %}">Sell</a></li>
                {% if is_seller %}
                <li><a href="{% url 'hc_app:dashboard' %}">Dashboard</a></li>
                {% endif %}
            </ul>
        </nav>

        <div class="nav-actions">
            <form method="get" action="{% url 'hc_app:search' %}" class="d-inline">   <!-- edit22 - added -->
                <input type="text" name="q" placeholder="Search" value="{{ request.GET.q }}">
            </form>
            
                {% if not user.is_authenticated %}
                <a href="{% url 'hc_app:register' %}">Sign Up</a>
                <a href="{% url 'hc_app:login' %}">Login</a>
                {% endif %}

                <a href="{% url 'hc_app:cart_view' %}">
                    ðŸ›’ Cart (<span id="cart-count">{{ cart_count }}</span>)
                </a>
        </div>

        {% if user.is_authenticated %}
        <div class="profile-section" style="position: absolute; right: 20px; top: 10px;">
            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-person-circle"></i> {{ user.username }}
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li class="dropdown-header">Profile</li>
                    <li><span class="dropdown-item-text"><strong>Email:</strong> {{ user.email }}</span></li>
                    {% if user_profile and user_profile.contact_number %}
                        <li><span class="dropdown-item-text"><strong>Contact:</strong> {{ user_profile.contact_number }}</span></li>
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{% url 'hc_app:orders' %}">My Orders</a></li>
                    {% if is_seller %}
                        <li><a class="dropdown-item" href="{% url 'hc_app:dashboard' %}">Dashboard</a></li>
                    {% endif %}
                    <li><a class="dropdown-item" href="{% url 'hc_app:password_change' %}">Change Password</a></li>
                    <li><a class="dropdown-item" href="{% url 'hc_app:logout' %}">Logout</a></li>

                    {% if is_seller %}
                        <li><hr class="dropdown-divider"></li>
                        <!-- Open confirmation modal instead of linking directly -->
                        <li>
                            <button type="button" class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#deactivateModal">
                                Deactivate Account
                            </button>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
        {% endif %}

    </header>


    <main>
        {% block content %}
        {% endblock %}
    </main>


    <footer>
        <div class="footer-logo">
            <h2>HandaCraftPH</h2>
            <p>Â© 2025</p>
        </div>
        <div class="footer-links">
            <a href="#">Help Center</a>
            <a href="#">Terms</a>
            <a href="#">Privacy</a>
            <a href="#">About</a>
            <a href="#">Contact Us</a>
        </div>
    </footer>

    {% block scripts %}{% endblock %}
    
        {# Deactivate confirmation modal - shown when user clicks Deactivate Account in profile dropdown #}
        <div class="modal fade" id="deactivateModal" tabindex="-1" aria-labelledby="deactivateModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deactivateModalLabel">Confirm deactivation</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-2">Deactivating your account will make it inactive. You will be logged out and will not be able to sign in until an administrator reactivates your account. This action can be reversed by admins but not from the user interface.</p>
                        <p class="text-muted small">To confirm, type your username below and click <strong>Deactivate</strong>.</p>
                        <div class="mb-2">
                            <label for="deactivate-confirm-input" class="form-label small">Type your username to confirm</label>
                            <input id="deactivate-confirm-input" name="confirm_username" type="text" class="form-control" placeholder="{{ user.username }}">
                            <div id="deactivate-help" class="form-text small text-muted">Username must match exactly.</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <form id="deactivate-form" method="post" action="{% url 'hc_app:deactivate_account' %}" style="display:inline">
                {% csrf_token %}
                <button id="deactivate-confirm-btn" type="submit" class="btn btn-danger" disabled>Deactivate</button>
            </form>
                    </div>
                </div>
            </div>
        </div>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
        const forms = document.querySelectorAll(".add-to-cart-form");

        forms.forEach(form => {
            form.addEventListener("submit", function(e) {
            e.preventDefault();
            const productId = this.dataset.productId;
            const csrfToken = this.querySelector("[name=csrfmiddlewaretoken]").value;
            const action = this.getAttribute('action') || this.dataset.action;

            fetch(action, {
                method: "POST",
                headers: {
                "X-CSRFToken": csrfToken,
                "X-Requested-With": "XMLHttpRequest",
                "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"
                },
                body: `quantity=${encodeURIComponent(this.querySelector('[name=quantity]') ? this.querySelector('[name=quantity]').value : 1)}`
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById("cart-count").textContent = data.count;
            })
            .catch(error => console.error("Error:", error));
            });
        });
        });
</script>
<script>
    // Deactivate confirmation: enable submit only when typed username matches current user
    document.addEventListener('DOMContentLoaded', function () {
        const input = document.getElementById('deactivate-confirm-input');
        const btn = document.getElementById('deactivate-confirm-btn');
        if (!input || !btn) return;
        const expected = "{{ user.username|escapejs }}";
        function check() {
            const val = (input.value || '').trim();
            if (val === expected) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }
        input.addEventListener('input', check);
        // optional: clear on modal hide
        const modalEl = document.getElementById('deactivateModal');
        if (modalEl) {
            modalEl.addEventListener('hidden.bs.modal', function () {
                input.value = '';
                btn.disabled = true;
            });
        }
    });
</script>

</body>
</html>
